{% extends 'hod_template/base_template.html' %}
{% block page_title %}
Add New Admin
{% endblock page_title %}
{% load static %}
{% block main_content %}
<!-- Main content -->
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <!-- general form elements -->
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">Add Admin</h3>
          </div>
          <!-- /.card-header -->
          <!-- form start -->
          <form role="form" action="/add_admin/" method="post" enctype="multipart/form-data" id="admin-form">
            {% csrf_token %}
            <div class="card-body">
              <div class="form-group">
                <label>Email address</label>
                <input type="email" class="form-control" name="email" placeholder="Enter email" required
                  hx-post="{% url 'check_email' %}" hx-trigger="keyup changed delay:500ms" hx-target="#email-error">
                <div id="email-error" class="validation-message small"></div>
              </div>
              <div class="form-group">
                <label>Password</label>
                <div style="position: relative;">
                  <input type="password" class="form-control" name="password" placeholder="Password" required
                    pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$"
                    oninput="validatePassword(this)">
                  <button class="toggle-password" type="button" style="position: absolute; right: 12px; top: 50%; transform: translateY(-50%);
                                         background: none; border: none; cursor: pointer; padding: 0; outline: none;
                                         z-index: 2; display: none;">
                    <i class="fas fa-eye"></i>
                  </button>
                </div>
                <div id="password-strength" class="validation-message small"></div>
              </div>
              <div class="form-group">
                <label>First Name</label>
                <input type="text" class="form-control" placeholder="First Name" name="first_name" required>
              </div>
              <div class="form-group">
                <label>Last Name</label>
                <input type="text" class="form-control" placeholder="Last Name" name="last_name" required>
              </div>
              <div class="form-group">
                <label>Username</label>
                <input type="text" class="form-control" placeholder="Username" name="username" required
                  pattern="^[a-zA-Z0-9_]{4,20}$" hx-post="{% url 'check_username' %}"
                  hx-trigger="keyup changed delay:500ms" hx-target="#username-error">
                <div id="username-error" class="validation-message small"></div>
              </div>
              <div class="form-group">
                <label>Gender</label>
                <select class="form-control" name="gender" required>
                  <option value="">Select Gender</option>
                  <option value="Male">Male</option>
                  <option value="Female">Female</option>
                  <option value="Other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label>Qualification</label>
                <input type="text" class="form-control" placeholder="Qualification" name="qualification">
              </div>
              <div class="form-group">
                <label>Address</label>
                <input type="text" class="form-control" placeholder="Address" name="address" required>
              </div>
              <div class="form-group">
    <label>Phone Number</label>
    <input type="tel" class="form-control" placeholder="Phone Number" name="phone_number"
           pattern="[0-9]{10}" 
           maxlength="10"
           hx-post="{% url 'check_phone' %}" 
           hx-trigger="keyup changed delay:500ms"
           hx-target="#phone-error"
           oninput="validatePhone(this)"
           onkeypress="return event.charCode >= 48 && event.charCode <= 57">
    <div id="phone-error" class="validation-message small"></div>
</div>
              <div class="form-group">
                <label>Profile Picture</label>
                <input type="file" class="form-control" name="profile_pic">
              </div>
              <div class="form-group">
                {% if messages %}
                {% for message in messages %}
                {% if message.tags == 'error' %}
                <div class="alert alert-danger" style="margin-top:10px">{{ message }}</div>
                {% endif %}
                {% if message.tags == 'success' %}
                <div class="alert alert-success" style="margin-top:10px">{{ message }}</div>
                {% endif %}
                {% endfor %}
                {% endif %}
              </div>
            </div>
            <!-- /.card-body -->

            <div class="card-footer">
              <button type="submit" class="btn btn-primary btn-block">Add Admin</button>
            </div>
          </form>
        </div>
        <!-- /.card -->
      </div>
    </div>
  </div>
</section>
<!-- /.content -->
{% endblock main_content %}

{% block custom_js %}
<script src="https://unpkg.com/htmx.org@1.9.6"></script>
<script>
  // Enhanced validation functions
  function validateUsername(input) {
    const username = input.value;
    const isValidFormat = /^[a-zA-Z0-9_]{4,20}$/.test(username);

    updateValidationUI(input, isValidFormat,
      isValidFormat ? "✓ Username format valid" : "✗ 4-20 chars (letters, numbers, _)");
  }

  function validatePassword(input) {
    const password = input.value;
    const requirements = {
      length: password.length >= 8,
      upper: /[A-Z]/.test(password),
      lower: /[a-z]/.test(password),
      number: /[0-9]/.test(password),
      special: /[@$!%*?&]/.test(password)
    };

    const isValid = Object.values(requirements).every(Boolean);

    // Show/hide toggle button
    const toggleBtn = input.parentElement.querySelector('.toggle-password');
    if (toggleBtn) {
      toggleBtn.style.display = password.length > 0 ? 'block' : 'none';
    }

    // Create validation message
    let message = '<div class="password-requirements"><strong>Password Requirements:</strong><ul>';
    message += requirements.length ? '<li class="text-success">✓ At least 8 characters</li>' : '<li class="text-danger">✗ At least 8 characters</li>';
    message += requirements.upper ? '<li class="text-success">✓ Uppercase letter</li>' : '<li class="text-danger">✗ Uppercase letter</li>';
    message += requirements.lower ? '<li class="text-success">✓ Lowercase letter</li>' : '<li class="text-danger">✗ Lowercase letter</li>';
    message += requirements.number ? '<li class="text-success">✓ Number</li>' : '<li class="text-danger">✗ Number</li>';
    message += requirements.special ? '<li class="text-success">✓ Special character (@$!%*?&)</li>' : '<li class="text-danger">✗ Special character (@$!%*?&)</li>';
    message += '</ul>';

    // Show example when password has content or field is focused
    if (password.length > 0 || document.activeElement === input) {
      message += '<small class="text-muted">Example: Secure@123!</small>';
    }
    message += '</div>';

    // Update UI
    const errorElement = document.getElementById('password-strength');
    if (errorElement) {
      errorElement.innerHTML = message;
      errorElement.className = `validation-message small ${isValid ? 'text-success' : 'text-danger'}`;
    }

    input.classList.toggle('is-valid', isValid);
    input.classList.toggle('is-invalid', !isValid);
    return isValid;
  }

  function validatePhone(input) {
    // Remove any non-digit characters
    input.value = input.value.replace(/\D/g, '');
    
    // Limit to 10 characters
    if (input.value.length > 10) {
        input.value = input.value.slice(0, 10);
    }
    
    const isValid = input.value.length === 10;
    updateValidationUI(input, isValid, 
        isValid ? "✓ Valid phone number" : "✗ Must be 10 digits");
}

  function validateEmail(input) {
    const email = input.value;
    const isValidFormat = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);

    updateValidationUI(input, isValidFormat,
      isValidFormat ? "✓ Email format valid" : "✗ Enter a valid email address");
  }

  function updateValidationUI(input, isValid, message) {
    const fieldName = input.name;
    const errorElement = document.getElementById(`${fieldName}-error`);

    if (errorElement) {
      errorElement.textContent = message;
      errorElement.className = `validation-message small ${isValid ? 'text-success' : 'text-danger'}`;
    }

    input.classList.toggle('is-valid', isValid);
    input.classList.toggle('is-invalid', !isValid);
  }

  // Initialize event listeners
  document.addEventListener('DOMContentLoaded', function () {
    // Password toggle functionality
    const passwordInput = document.querySelector('[name="password"]');
    const toggleBtn = document.querySelector('.toggle-password');

    if (passwordInput && toggleBtn) {
      toggleBtn.addEventListener('click', function () {
        if (passwordInput.type === 'password') {
          passwordInput.type = 'text';
          this.innerHTML = '<i class="fas fa-eye-slash"></i>';
        } else {
          passwordInput.type = 'password';
          this.innerHTML = '<i class="fas fa-eye"></i>';
        }
      });

      passwordInput.addEventListener('input', function () {
        toggleBtn.style.display = this.value.length > 0 ? 'block' : 'none';
        validatePassword(this);
      });

      passwordInput.addEventListener('focus', function () {
        validatePassword(this);
      });
    }

    // Validation listeners
    document.querySelector('[name="username"]')?.addEventListener('input', function () {
      validateUsername(this);
    });

    document.querySelector('[name="password"]')?.addEventListener('input', function () {
      validatePassword(this);
    });

    document.querySelector('[name="phone_number"]')?.addEventListener('input', function () {
      validatePhone(this);
    });

    document.querySelector('[name="email"]')?.addEventListener('input', function () {
      validateEmail(this);
    });

    // Initialize validation for any pre-filled fields
    document.querySelectorAll('[name="username"], [name="password"], [name="phone_number"], [name="email"]').forEach(input => {
      if (input.value.length > 0) {
        const validator = {
          'username': validateUsername,
          'password': validatePassword,
          'phone_number': validatePhone,
          'email': validateEmail
        }[input.name];

        if (validator) validator(input);
      }
    });
  });

  // Handle HTMX responses
  document.body.addEventListener('htmx:afterRequest', function (evt) {
    const input = evt.detail.elt;
    const response = evt.detail.xhr.response;

    try {
      const data = JSON.parse(response);

      if (input.name === 'username' && data.is_taken !== undefined) {
        const errorElement = document.getElementById('username-error');
        if (errorElement) {
          const isValidFormat = /^[a-zA-Z0-9_]{4,20}$/.test(input.value);
          if (data.is_taken) {
            errorElement.textContent = "✗ Username already taken";
            errorElement.className = 'validation-message small text-danger';
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
          } else if (isValidFormat) {
            errorElement.textContent = "✓ Username available";
            errorElement.className = 'validation-message small text-success';
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
          }
        }
      }

      if (input.name === 'phone_number' && data.is_taken !== undefined) {
        const errorElement = document.getElementById('phone-error');
        if (errorElement) {
          errorElement.textContent = data.is_taken ?
            "✗ Phone already registered" : "✓ Phone available";
          errorElement.className = `validation-message small ${data.is_taken ? 'text-danger' : 'text-success'}`;
          input.classList.toggle('is-invalid', data.is_taken);
          input.classList.toggle('is-valid', !data.is_taken);
        }
      }

      if (input.name === 'email' && data.is_taken !== undefined) {
        const errorElement = document.getElementById('email-error');
        if (errorElement) {
          errorElement.textContent = data.is_taken ?
            "✗ Email already registered" : "✓ Email available";
          errorElement.className = `validation-message small ${data.is_taken ? 'text-danger' : 'text-success'}`;
          input.classList.toggle('is-invalid', data.is_taken);
          input.classList.toggle('is-valid', !data.is_taken);
        }
      }
    } catch (e) {
      console.error("Error parsing HTMX response", e);
    }
  });
</script>

<style>
  /* Validation message styling */
  .validation-message {
    font-size: 0.875em;
    margin-top: 0.25rem;
  }

  .text-success {
    color: #28a745;
  }

  .text-danger {
    color: #dc3545;
  }

  /* Form field styling */
  .is-valid {
    border-color: #28a745 !important;
  }

  .is-invalid {
    border-color: #dc3545 !important;
  }

  /* Password requirements styling */
  .password-requirements {
    background: #f8f9fa;
    padding: 10px;
    border-radius: 4px;
    margin-top: 5px;
  }

  .password-requirements ul {
    padding-left: 20px;
    margin: 5px 0;
  }

  .password-requirements li {
    list-style-type: none;
    margin-bottom: 3px;
  }

  .password-requirements small.text-muted {
    display: block !important;
    margin-top: 8px;
    color: #6c757d !important;
    font-style: italic;
  }

  /* Password toggle button styling */
  .toggle-password {
    opacity: 0.6;
    transition: opacity 0.2s;
    position: absolute;
    right: 12px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    padding: 0;
    outline: none;
    z-index: 2;
    display: none;
  }

  .toggle-password:hover {
    opacity: 1;
  }

  /* Add Font Awesome for eye icons */
  @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css');
</style>
{% endblock custom_js %}