{% extends 'student_template/base_template.html' %}
{% block page_title %}
View Attendance Data
{% endblock page_title %}

{% block main_content %}
<section class="content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-md-12">
        <div class="card card-primary">
          <div class="card-header">
            <h3 class="card-title">View Attendance</h3>
          </div>
          <form action="{% url 'student_view_attendance_post' %}" method="post">
            <div class="card-body">
              {% csrf_token %}
              <div class="form-group">
                <label>Subject</label>
                {% if subjects %}
                  <select class="form-control" name="subject" id="subject" required>
                    <option value="">-- Select Subject --</option>
                    {% for subject in subjects %}
                      <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                    {% endfor %}
                  </select>
                {% else %}
                  <div class="alert alert-warning">
                    No subjects available for your course: {{ student_course.course_name }}
                  </div>
                {% endif %}
              </div>
              
              <div class="row">
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>Start Date</label>
                    <input type="date" name="start_date" class="form-control" required>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="form-group">
                    <label>End Date</label>
                    <input type="date" name="end_date" class="form-control" required>
                  </div>
                </div>
              </div>
              
              {% if messages %}
                {% for message in messages %}
                  <div class="alert alert-{{ message.tags }}" style="margin-top:10px">
                    {{ message }}
                  </div>
                {% endfor %}
              {% endif %}
            </div>

            <div class="card-footer">
              {% if subjects %}
                <button type="submit" class="btn btn-primary btn-block">
                  Fetch Attendance
                </button>
              {% else %}
                <button type="button" class="btn btn-primary btn-block" disabled>
                  No Subjects Available
                </button>
              {% endif %}
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Attendance Results Section -->
    {% if attendance_reports %}
    <div class="row">
      <div class="col-md-12">
        <div class="card card-success">
          <div class="card-header">
            <h3 class="card-title">Attendance Records</h3>
            <div class="card-tools">
              <span class="badge badge-light">
                {{ start_date }} to {{ end_date }}
              </span>
            </div>
          </div>
          <div class="card-body p-0">
            <div class="table-responsive">
              <table class="table table-striped table-hover">
                <thead class="thead-light">
                  <tr>
                    <th>Date</th>
                    <th>Day</th>
                    <th>Status</th>
                    <th>Subject</th>
                    <th>Session</th>
                  </tr>
                </thead>
                <tbody>
                  {% for report in attendance_reports %}
                  <tr>
                    <td>{{ report.attendance_id.attendance_date|date:"M d, Y" }}</td>
                    <td>{{ report.attendance_id.attendance_date|date:"" }}</td>
                    <td>
                      {% if report.status %}
                        <span class="badge badge-success">Present</span>
                      {% else %}
                        <span class="badge badge-danger">Absent</span>
                      {% endif %}
                    </td>
                    <td>{{ report.attendance_id.subject_id.subject_name }}</td>
                    <td>{{ report.attendance_id.session_year_id }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
                <tfoot>
                  <tr>
                    <td colspan="5" class="text-right">
                      <strong>Summary:</strong>
                      <span class="text-success">Present: {{ present_count }}</span> |
                      <span class="text-danger">Absent: {{ absent_count }}</span> |
                      <span class="text-primary">Total: {{ total_count }}</span>
                    </td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
          <div class="card-footer">
            <div class="progress">
              <div class="progress-bar bg-success" role="progressbar" 
                   style="width: {{ attendance_percentage }}%" 
                   aria-valuenow="{{ attendance_percentage }}" 
                   aria-valuemin="0" 
                   aria-valuemax="100">
                {{ attendance_percentage }}% Attendance
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</section>
{% endblock main_content %}

{% block custom_css %}
<style>
  .table-responsive {
    max-height: 500px;
    overflow-y: auto;
  }
  .progress {
    height: 25px;
  }
  .progress-bar {
    font-size: 14px;
    line-height: 25px;
  }
  .badge-success {
    background-color: #28a745;
  }
  .badge-danger {
    background-color: #dc3545;
  }
</style>
{% endblock custom_css %}